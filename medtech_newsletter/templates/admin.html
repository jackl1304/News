{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
        <i class="fas fa-tachometer-alt me-2"></i>
        Admin Dashboard
    </h1>
    <div class="btn-group">
        <button type="button" class="btn btn-primary" onclick="manualScraping()">
            <i class="fas fa-sync me-1"></i>
            Manuelles Scraping
        </button>
        <button type="button" class="btn btn-success" onclick="manualNewsletter()">
            <i class="fas fa-paper-plane me-1"></i>
            Newsletter generieren
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Benutzer</h5>
                <p class="card-text">{{ stats.total_subscribers }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Dokumente</h5>
                <p class="card-text">{{ stats.total_documents }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Änderungen</h5>
                <p class="card-text">{{ stats.pending_changes }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Newsletter</h5>
                <p class="card-text">{{ stats.recent_newsletters|length }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        Benutzerverwaltung
    </div>
    <div class="card-body">
        <button class="btn btn-primary" onclick="loadUsers()">Benutzer laden</button>
        <div id="user-list" class="mt-3 table-responsive"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Manuelle Aktionen
    async function manualScraping() {
        if (!confirm('Manuelles Scraping starten?')) return;
        const response = await fetch('/admin/manual-scraping', { method: 'POST' });
        const result = await response.json();
        alert(result.message || result.error);
    }

    async function manualNewsletter() {
        if (!confirm('Newsletter-Generierung starten?')) return;
        const response = await fetch('/admin/manual-newsletter', { method: 'POST' });
        const result = await response.json();
        alert(result.message || result.error);
    }
    
    // Benutzer laden und löschen
    async function deleteUser(userId) {
        if (!confirm(`Möchten Sie den Benutzer mit der ID ${userId} wirklich löschen?`)) {
            return;
        }
        const response = await fetch(`/admin/user/delete/${userId}`, {
            method: 'POST',
        });
        const result = await response.json();
        alert(result.message || result.error);
        loadUsers(); // Liste neu laden
    }

    async function loadUsers() {
        const response = await fetch('/admin/users');
        const users = await response.json();
        const userListDiv = document.getElementById('user-list');
        
        let tableHtml = `<table class="table table-striped table-sm"><thead><tr><th>ID</th><th>E-Mail</th><th>Admin</th><th>Aktionen</th></tr></thead><tbody>`;
        users.forEach(user => {
            // Verhindern, dass der Löschen-Button für den Admin angezeigt wird, falls es nur einen Admin gibt
            let deleteButton = '';
            if (!user.is_admin) {
                 deleteButton = `<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Löschen</button>`;
            }

            tableHtml += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.is_admin ? '<span class="badge bg-success">Ja</span>' : '<span class="badge bg-secondary">Nein</span>'}</td>
                    <td>${deleteButton}</td>
                </tr>
            `;
        });
        tableHtml += `</tbody></table>`;
        userListDiv.innerHTML = tableHtml;
    }
</script>
{% endblock %}
